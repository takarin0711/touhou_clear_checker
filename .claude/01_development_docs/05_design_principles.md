# 設計方針・原則

## 概要
このドキュメントは、touhou_clear_checkerプロジェクトの設計方針と開発原則を明記したものです。コードの一貫性と保守性を保つため、開発時はこれらの原則に従ってください。

## 1. マジックナンバーの禁止

### 原則
**ハードコーディングされた数値（マジックナンバー）の使用を極力避ける**

### 理由
- コードの可読性向上
- 保守性の向上
- 設定変更の容易性
- バグの発生リスク軽減

### 実装方針

#### バックエンド
- `domain/constants/` ディレクトリに定数ファイルを配置
- ゲーム関連の数値は `game_constants.py` で管理
- データベース関連の数値も定数化
- 設定値は環境変数または定数として管理

**例:**
```python
# ❌ マジックナンバー使用
if game_id == 1:
    char_range = (19, 22)
elif game_id == 2:
    char_range = (23, 28)

# ✅ 定数使用
char_range = get_character_range_for_game(game_id)
```

#### フロントエンド
- `src/constants/` ディレクトリに定数ファイルを配置
- API関連の設定は `apiConstants.js` で管理
- ゲーム関連の定数は `gameConstants.js` で管理
- UI関連の数値も定数化

**例:**
```javascript
// ❌ マジックナンバー使用
timeout: 5000,
if (game.series_number === 7) {

// ✅ 定数使用
timeout: API_CONFIG.TIMEOUT,
if (isPhantasmAvailable(game.series_number)) {
```

## 2. コーディング原則

### 共通原則
- **依存性注入**: インターフェースに依存し、具象クラスに依存しない
- **単一責任の原則**: 1つのクラス・関数は1つの責任を持つ
- **開放閉鎖の原則**: 拡張に開いて修正に閉じる
- **関心の分離**: UI/ロジック/データアクセスを分離

### バックエンド原則
- **SQLAlchemy ORM**: データベースアクセスはORM経由のみ
- **セッション管理**: 各リポジトリはSessionを受け取るコンストラクタ
- **型ヒント**: 全ての関数・メソッドに型ヒントを記述
- **async/await**: データベースアクセスは非同期処理

### フロントエンド原則
- **Custom Hooks**: API呼び出しはカスタムフックでカプセル化
- **純粋コンポーネント**: 副作用のない関数コンポーネント
- **Propsの最小化**: 必要最小限のPropsのみ受け取る
- **カスタムフック活用**: ロジックの再利用性を重視

## 3. 命名規則

### 定数命名
- **バックエンド**: `UPPER_SNAKE_CASE` 
- **フロントエンド**: `UPPER_SNAKE_CASE`
- **クラス定数**: クラス内でネストした定数クラスを使用

**例:**
```python
# Python
class GameIds:
    TOUHOU_06_EOSD = 1
    TOUHOU_07_PCB = 2

# JavaScript
export const GAME_IDS = {
  TOUHOU_06_EOSD: 1,
  TOUHOU_07_PCB: 2,
};
```

### ファイル命名
- **定数ファイル**: `xxxConstants.py` / `xxxConstants.js`
- **設定ファイル**: `xxxConfig.py` / `xxxConfig.js`

## 4. エラーハンドリング

### 原則
- **明示的なエラー処理**: すべてのエラーケースを明示的に処理
- **ユーザーフレンドリーなメッセージ**: 技術的なエラーをユーザー向けに変換
- **ログ出力**: デバッグ用の詳細情報をログに記録

### 実装
- エラーメッセージも定数として管理
- HTTP ステータスコードは定数を使用
- バックエンドではカスタム例外クラスを使用

## 5. データ設計原則

### データベース
- **第3正規形**: データの正規化を徹底
- **制約の明示**: NOT NULL, UNIQUE等の制約を適切に設定
- **インデックス**: パフォーマンス重要なカラムにインデックス作成
- **命名規則**: スネークケース（`clear_records`）
- **タイムスタンプ**: 必ず`created_at`, `updated_at`を設定

### API設計
- **RESTful**: REST原則に従ったURL設計
- **一貫性**: レスポンス形式の統一
- **バージョニング**: `/api/v1/`プレフィックス
- **ステータスコード**: 適切なHTTPステータスコードを使用

## 6. セキュリティ

### 原則
- **認証**: JWT トークンによる認証
- **認可**: ユーザー別のデータアクセス制御
- **入力検証**: すべての入力値を検証
- **秘密情報の保護**: API キー等の秘密情報は環境変数で管理

## 7. テスト

### 原則
- **単体テスト**: 各関数・メソッドの単体テスト
- **統合テスト**: API エンドポイントの統合テスト
- **E2E テスト**: 重要なユーザーフローのE2Eテスト

### カバレッジ
- **最低70%**: コードカバレッジ70%以上を目標
- **重要機能**: 認証、データ操作は100%カバレッジ

## 8. パフォーマンス

### 原則
- **遅延読み込み**: 必要な時に必要なデータのみ取得
- **キャッシュ**: 適切なキャッシュ戦略
- **最適化**: N+1問題の回避

### 実装
- **フロントエンド**: useMemo, useCallback の適切な使用
- **バックエンド**: SQLAlchemy の eager loading 活用

## 9. ドキュメント

### 原則
- **自己文書化**: コード自体が文書として機能
- **コメント**: 複雑なロジックには必要十分なコメント
- **型情報**: TypeScript風のJSDoc、Python型ヒント

### 更新
- **コード変更時**: 関連ドキュメントも同時更新
- **新機能追加時**: 設計書・API仕様書の更新

## まとめ

これらの設計原則は、コードの品質、保守性、可読性を向上させるためのガイドラインです。新しい機能の実装や既存コードの修正時は、必ずこれらの原則に従って作業を行ってください。

原則に関する疑問や改善提案がある場合は、プロジェクトチームで議論し、必要に応じてこのドキュメントを更新してください。