#!/usr/bin/env python3
"""
æ°¸å¤œæŠ„ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ›´æ–°
Wikièª¿æŸ»çµæœ: äººå¦–ã‚¿ãƒƒã‚°4ç¨® + äººé–“å˜ä½“4å + å¦–æ€ªå˜ä½“4å
"""

import sqlite3
import sys
from pathlib import Path

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
backend_dir = Path(__file__).parent.parent
sys.path.append(str(backend_dir))

def update_eiyashou_characters():
    """æ°¸å¤œæŠ„ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãæ›´æ–°"""
    
    db_path = backend_dir / "touhou_clear_checker.db"
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    try:
        # æ°¸å¤œæŠ„ã®ã‚²ãƒ¼ãƒ IDã‚’ç¢ºèª
        cursor.execute("SELECT id, title FROM games WHERE title LIKE '%æ°¸å¤œæŠ„%'")
        game_result = cursor.fetchone()
        
        if not game_result:
            print("âŒ æ°¸å¤œæŠ„ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            return
        
        game_id = game_result[0]
        print(f"âœ… æ°¸å¤œæŠ„ã‚²ãƒ¼ãƒ ID: {game_id}")
        
        # æ—¢å­˜ã®æ°¸å¤œæŠ„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        print("æ—¢å­˜ã®æ°¸å¤œæŠ„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤...")
        cursor.execute("DELETE FROM game_characters WHERE game_id = ?", (game_id,))
        print("âœ… æ—¢å­˜ã®æ°¸å¤œæŠ„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†")
        
        # Wikièª¿æŸ»çµæœã«åŸºã¥ãæ­£ã—ã„æ°¸å¤œæŠ„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        print("\nWikièª¿æŸ»çµæœã«åŸºã¥ãæ­£ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ä¸­...")
        
        eiyashou_characters = [
            # äººå¦–ã‚¿ãƒƒã‚°ï¼ˆåˆæœŸåˆ©ç”¨å¯èƒ½ï¼‰
            ('éœŠå¤¢&ç´«ï¼ˆã‚¿ãƒƒã‚°ï¼‰', 'å¹»æƒ³ã®çµç•Œçµ„', 1),
            ('é­”ç†æ²™&ã‚¢ãƒªã‚¹ï¼ˆã‚¿ãƒƒã‚°ï¼‰', 'ç¦å‘ªã®è© å”±çµ„', 2),
            ('å’²å¤œ&ãƒ¬ãƒŸãƒªã‚¢ï¼ˆã‚¿ãƒƒã‚°ï¼‰', 'å¤¢å¹»ã®ç´…é­”çµ„', 3),
            ('å¦–å¤¢&å¹½ã€…å­ï¼ˆã‚¿ãƒƒã‚°ï¼‰', 'å¹½å†¥ã®ä½äººçµ„', 4),
            
            # äººé–“å˜ä½“ï¼ˆå…¨ã‚¿ãƒƒã‚°ã§6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾ï¼‰
            ('éœŠå¤¢ï¼ˆå˜ä½“ï¼‰', 'äººé–“ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 5),
            ('é­”ç†æ²™ï¼ˆå˜ä½“ï¼‰', 'äººé–“ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 6),
            ('å’²å¤œï¼ˆå˜ä½“ï¼‰', 'äººé–“ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 7),
            ('å¦–å¤¢ï¼ˆå˜ä½“ï¼‰', 'äººé–“ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 8),
            
            # å¦–æ€ªå˜ä½“ï¼ˆå…¨ã‚¿ãƒƒã‚°ã§6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾ï¼‰
            ('ç´«ï¼ˆå˜ä½“ï¼‰', 'å¦–æ€ªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 9),
            ('ã‚¢ãƒªã‚¹ï¼ˆå˜ä½“ï¼‰', 'å¦–æ€ªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 10),
            ('ãƒ¬ãƒŸãƒªã‚¢ï¼ˆå˜ä½“ï¼‰', 'å¦–æ€ªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 11),
            ('å¹½ã€…å­ï¼ˆå˜ä½“ï¼‰', 'å¦–æ€ªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€å…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾', 12),
        ]
        
        # game_charactersãƒ†ãƒ¼ãƒ–ãƒ«ã«æ­£ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
        print("ã‚²ãƒ¼ãƒ ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œé–¢ä¿‚ã‚’è¨­å®šä¸­...")
        for char_name, description, sort_order in eiyashou_characters:
            cursor.execute("""
                INSERT INTO game_characters (game_id, character_name, description, sort_order)
                VALUES (?, ?, ?, ?)
            """, (game_id, char_name, description, sort_order))
        
        print("âœ… ã‚²ãƒ¼ãƒ ãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾å¿œé–¢ä¿‚è¨­å®šå®Œäº†")
        
        # ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        print("\nğŸ“Š æ°¸å¤œæŠ„ãƒ‡ãƒ¼ã‚¿ç¢ºèª:")
        
        cursor.execute("""
            SELECT COUNT(*) FROM game_characters WHERE game_id = ?
        """, (game_id,))
        count = cursor.fetchone()[0]
        print(f"æ°¸å¤œæŠ„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ•°: {count}")
        
        # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§è¡¨ç¤º
        cursor.execute("""
            SELECT character_name, description FROM game_characters
            WHERE game_id = ?
            ORDER BY sort_order
        """, (game_id,))
        characters = cursor.fetchall()
        
        print("\nğŸ“ æ°¸å¤œæŠ„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä¸€è¦§:")
        
        print("\nğŸ¤ äººå¦–ã‚¿ãƒƒã‚°ï¼ˆåˆæœŸåˆ©ç”¨å¯èƒ½ï¼‰:")
        for i, (char_name, desc) in enumerate(characters[:4], 1):
            print(f"  {i}. {char_name} - {desc}")
        
        print("\nğŸ‘¤ äººé–“å˜ä½“ï¼ˆå…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾ï¼‰:")
        for i, (char_name, desc) in enumerate(characters[4:8], 1):
            print(f"  {i}. {char_name}")
        
        print("\nğŸ‘» å¦–æ€ªå˜ä½“ï¼ˆå…¨ã‚¿ãƒƒã‚°6Bé¢ã‚¯ãƒªã‚¢å¾Œè§£æ”¾ï¼‰:")
        for i, (char_name, desc) in enumerate(characters[8:12], 1):
            print(f"  {i}. {char_name}")
        
        # 8ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ†é¡è¡¨ç¤º
        print("\nğŸ“ 8ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ†é¡:")
        human_chars = ['éœŠå¤¢', 'é­”ç†æ²™', 'å’²å¤œ', 'å¦–å¤¢']
        youkai_chars = ['ç´«', 'ã‚¢ãƒªã‚¹', 'ãƒ¬ãƒŸãƒªã‚¢', 'å¹½ã€…å­']
        
        print(f"äººé–“ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: {', '.join(human_chars)}")
        print(f"å¦–æ€ªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼: {', '.join(youkai_chars)}")
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        conn.commit()
        print(f"\nğŸ‰ æ°¸å¤œæŠ„ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†ï¼")
        print(f"ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«: {db_path}")
        print("\nğŸ“‹ æ›´æ–°å†…å®¹:")
        print("  - Wikièª¿æŸ»çµæœã«åŸºã¥ãæ­£ç¢ºãª8ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼")
        print("  - äººå¦–ã‚¿ãƒƒã‚°4ç¨®ï¼ˆåˆæœŸåˆ©ç”¨å¯èƒ½ï¼‰")
        print("  - äººé–“å˜ä½“4åï¼ˆè§£æ”¾å¾Œï¼‰")
        print("  - å¦–æ€ªå˜ä½“4åï¼ˆè§£æ”¾å¾Œï¼‰")
        print("  - æ…§éŸ³&å¦¹ç´…ã‚’å‰Šé™¤ï¼ˆæ­£å¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã¯ãªã„ï¼‰")
        
    except Exception as e:
        conn.rollback()
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        raise
    finally:
        conn.close()

if __name__ == "__main__":
    update_eiyashou_characters()